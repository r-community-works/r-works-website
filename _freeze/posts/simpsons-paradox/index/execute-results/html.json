{
  "hash": "a45ea26afd9e8d47193dc20ff7053540",
  "result": {
    "markdown": "---\ntitle: \"Simpson's Paradox in a Logistic Regression\"\nauthor: \"Nina Zumel\"\ndate: 2025-02-08\nhtml:\n    code-fold: true\n    code-summary: \"Show the code\"\neditor: source\ndescription: \"\"\nimage: \"\"\nimage-alt: \"\"\ncategories: \"Puzzle Corner\"\n---\n\n\n[Simpson's paradox](https://en.wikipedia.org/wiki/Simpson's_paradox) is when a\ntrend that is present in various groups of data seems to disappear or even reverse\nwhen those groups are combined. One sees examples of this often in things like \nmedical trials, and the phenomenon is generally due to one or more unmodelled\nconfounding variables, or perhaps differing causal assumptions.\n\nIn the course of something else that I was working on, I was trying to come\nup with an example of a logistic regression analysis, where one of the coefficients\nhad a clearly incorrect sign. This is because I wanted an example beyond a simple linear regression.\nThere are several reasons why unexpected signs might happen: separation or quasiseparation of the data being the obvious ones. But Simpson's paradox is another possible cause.\n\nThe original project ended up not needing the example, but since I had it, I thought I'd write it up, \nsince I've never seen Simpson's paradox presented in quite this way before.\n\n## Synthetic Example: Weight Loss Trial\n\nThis is a problem statement where we would expect the coefficients of\na logistic regression to be non-negative (except the intercept).\n\nConsider a trial that tests the efficacy of a specific eating regimen \n(let's say 16/8 intermittent fasting, which we'll call `ifasting`) \nand a specific exercise regimen (a brisk 30 minute walk every day, which we'll \njust call `exercise`). The goal (\"success\") is to lose at least five pounds by the end of \nthe trial period. We've set up three treatment groups, as follows:\n\n* 200 subjects try exercise alone\n* 300 subjects try ifasting alone\n* 300 subjects try ifasting plus exercise\n\nPrior to the trial, all the subjects led fairly sedentary lifestyles, \nand weren't dieting in any formal way.\n\nFor these subjects, one might reasonably expect that neither exercise nor ifasting \nwould be *less* successful for losing weight than doing nothing. One would also reasonably\nexpect that ifasting plus exercise should do no worse than doing either one alone.\nTherefore, modeling the results of such an experiment as a logistic regression\nshould lead to a model where the coefficients $\\beta_{ifasting}$ and\n$\\beta_{exercise}$ are both non-negative, as any treatment should increase (or at least, not decrease) the\nodds that the subject loses weight. \n\nLet's show an example where our expectations aren't met. The easiest way to do that is to\ngenerate a dataset that has Simpson's paradox hidden within it.\n\nHere's a function that will generate a specific subset of datums, as needed.\n\n\n::: {.cell warnings='false'}\n\n```{.r .cell-code}\nlibrary(poorman) # or dplyr\nlibrary(ggplot2)\nlibrary(kableExtra)\nlibrary(WVPlots)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# ifasting: 1 if this group fasted, else 0\n# exercise: 1 if this group exercised, else 0\n# total: total number of subjects in this group\n# successes:  number of subjects who successfully lost weight\n# label: label for the group.\ngenerate_samples = function(ifasting, exercise, total, successes, label) {\n  failures = total-successes\n  data.frame(ifasting = ifasting,\n             exercise = exercise,\n             success = c(rep(1, successes), rep(0, failures)),\n             label=label)\n}\n```\n:::\n\n\n\n## Hidden, Unmodelled Population Effects\n\nNow suppose that, unbeknownst to the researchers, there are two subpopulations\namongst the subjects. These two populations respond differently to the exercise and\nintermittent fasting regimes. So we will generate our synthetic data by population.\n\n### Population A\n\nThe first population, Population A, responds quite well to intermittent fasting. Let's create just this population.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# population A\npopA = data.table::rbindlist(list(\n  generate_samples(ifasting=0, exercise=1, total=100, successes=2, \"Population A\"),\n  generate_samples(ifasting=1, exercise=0, total=200, successes=160, \"Population A\"),\n  generate_samples(ifasting=1, exercise=1, total=100, successes=90, \"Population A\")\n))\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nIf we look at the success rates, we will see that (as expected) subjects who both exercise and practice intermittent fasting \nlose weight more successfully than subjects who do one or the other alone.\n\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Success rates, Population A\n\n|treatment      | success_rate|\n|:--------------|------------:|\n|exercise alone |         0.02|\n|ifast alone    |         0.80|\n|both           |         0.90|\n|overall        |         0.63|\n:::\n:::\n\n\n### Population B\n\nThere is also another population, Population B, that has what you might call a \"stickier\" metabolism.\nFor them, intermittent fasting is not quite as effective.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npopB = data.table::rbindlist(list(\n  generate_samples(ifasting=0, exercise=1, total=100, successes=1, \"Population B\"),\n  generate_samples(ifasting=1, exercise=0, total=100, successes=40, \"Population B\"),\n  generate_samples(ifasting=1, exercise=1, total=200, successes=100, \"Population B\")\n))\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nAgain, subjects who both exercise and practice intermittent fasting are the most successful, but overall, success rates\nin population B are not as good as in population A.\n\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Success rates, Population B\n\n|treatment      | success_rate|\n|:--------------|------------:|\n|exercise alone |        0.010|\n|ifast alone    |        0.400|\n|both           |        0.500|\n|overall        |        0.352|\n:::\n:::\n\n\nOne of the things to notice about this experimental design is that, even before taking the hidden population types into account, the treatment groups are not balanced. We saw this in the initial statement above (200 subjects try exercise alone; 300 subjects try ifasting alone; 300 subjects try ifasting plus exercise). This is often what happens in experimental trials with human subjects. as subjects may drop out for one reason or another. Unbalanced treatment groups tend to be the norm in retrospective analyses, as well.\n\nThis imbalance will be even more pronounced when we account for the hidden population types, as well.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nThis population imbalance is part of what can cause Simpson's paradox.\n\n## Modelling\n\nNow let's fit a logistic regression model to try to infer the effects of the various treatments on weight loss. We'll do it on the whole population first, since that was the original task.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbothpops = rbind(popA, popB)\nmAll = glm(success ~ ifasting + exercise, data=bothpops, family=binomial)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Model coefficients, whole population\n\n|            |Estimate                                                  |pval                                                            |\n|:-----------|:---------------------------------------------------------|:---------------------------------------------------------------|\n|(Intercept) |<span style=\"     color: red !important;\" >-4.038</span>  |<span style=\"     color: darkblue !important;\" >2.72e-11</span> |\n|ifasting    |<span style=\"     color: black !important;\" >4.731</span> |<span style=\"     color: darkblue !important;\" >1.6e-15</span>  |\n|exercise    |<span style=\"     color: red !important;\" >-0.147</span>  |<span style=\"     color: darkgray !important;\" >0.392</span>    |\n:::\n:::\n\n\nIntermittent fasting has a positive coefficient, meaning intermittent fasting is positively correlated with weight loss success. But\nexercise has a *negative* coefficient, implying the exercise is negatively correlated with weight loss, and that doing both together\nwill be *less* successful than intermittent fasting alone!\n\nAnd indeed, if we look at the raw summaries, we'll see that the data bears these inferences out.\n\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Success rates, entire population\n\n|treatment      | success_rate|\n|:--------------|------------:|\n|exercise alone |        0.015|\n|ifast alone    |        0.667|\n|both           |        0.633|\n|overall        |        0.491|\n:::\n:::\n\n\nThis is an example of how Simpson’s paradox might manifest itself in a logistic regression model, and it’s due to the unmodelled confounding variable, population type. This, plus some bad luck in the relative sizes of the treatment groups with respect to population type, lead to the above, counterintuitive, results. \n\nNote that we have reported p-values, and in this case the coefficient for exercise is insignificant (to $p = 0.05$), implying that exercise may not have any notable effect on weight loss. However, we may still see coefficients with counterintuitive signs in arbitrarily large populations, which may then appear significant.\n\n### Taking the Hidden Confounder into Account\n\nAs you might expect, if we are able to identify the confounding variable and account for it, then we can eliminate the paradoxical negative coefficients. To see this, let's first model the populations separately and look at the model coefficients.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmA = glm(success ~ ifasting + exercise, data=popA, family=binomial)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Model coefficients, Population A\n\n|            |Estimate                                                  |pval                                                            |\n|:-----------|:---------------------------------------------------------|:---------------------------------------------------------------|\n|(Intercept) |<span style=\"     color: red !important;\" >-4.703</span>  |<span style=\"     color: darkblue !important;\" >5.82e-09</span> |\n|ifasting    |<span style=\"     color: black !important;\" >6.089</span> |<span style=\"     color: darkblue !important;\" >1.12e-14</span> |\n|exercise    |<span style=\"     color: black !important;\" >0.811</span> |<span style=\"     color: darkblue !important;\" >0.0316</span>   |\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmB = glm(success ~ ifasting + exercise, data=popB, family=binomial)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Model coefficients, Population B\n\n|            |Estimate                                                  |pval                                                            |\n|:-----------|:---------------------------------------------------------|:---------------------------------------------------------------|\n|(Intercept) |<span style=\"     color: red !important;\" >-5.001</span>  |<span style=\"     color: darkblue !important;\" >1.36e-06</span> |\n|ifasting    |<span style=\"     color: black !important;\" >4.595</span> |<span style=\"     color: darkblue !important;\" >5.97e-06</span> |\n|exercise    |<span style=\"     color: black !important;\" >0.405</span> |<span style=\"     color: darkgray !important;\" >0.103</span>    |\n:::\n:::\n\n\nIn both cases, both intermittent fasting and exercise have positive coefficients, indicating that both activities correlate positively with weight loss.\n\nWe can also model the entire population, including the population label as a variable.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmAllplus = glm(success ~ ifasting + exercise + label, data=bothpops, family=binomial)\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\nTable: Model coefficients, whole population with population labels\n\n|                  |Estimate                                                  |pval                                                            |\n|:-----------------|:---------------------------------------------------------|:---------------------------------------------------------------|\n|(Intercept)       |<span style=\"     color: red !important;\" >-4.143</span>  |<span style=\"     color: darkblue !important;\" >1.69e-11</span> |\n|ifasting          |<span style=\"     color: black !important;\" >5.584</span> |<span style=\"     color: darkblue !important;\" >1.15e-19</span> |\n|exercise          |<span style=\"     color: black !important;\" >0.523</span> |<span style=\"     color: darkblue !important;\" >0.0102</span>   |\n|labelPopulation B |<span style=\"     color: red !important;\" >-1.917</span>  |<span style=\"     color: darkblue !important;\" >7.65e-20</span> |\n:::\n:::\n\n\nAs expected, both `ifasting` and `exercise` now have positive (and significant, to $p=0.05$) coefficients, indicating that both actions increase the probability of weight loss, and doing them both increases it even more.\n\nThe model also correctly identifies that subjects of population type B have a (significantly) lower success rate than subjects from Population A.\n\n\n## Conclusion\n\nSimpson's paradox is a case where model inference seems to contradict domain knowledge. Usually it is merely a symptom of some combination of omitted variable bias, unbalanced studies, or wrong causal specification (or perhaps no such specification). If you take care to look for the this effect, it can in fact give clues towards a better analysis.\n\n*Nina Zumel is a data scientist based in San Francisco, with 20+ years of experience in machine learning, statistics, and analytics. She is the co-founder of the data science consulting firm Win-Vector LLC, and (with John Mount) the co-author of Practical Data Science with R, now in its second edition.*",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}